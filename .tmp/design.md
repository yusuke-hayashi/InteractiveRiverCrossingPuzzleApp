# セッション管理機能の設計

## 要件
1. **セッション識別**: 開始からリセットまでの一連のデータを識別
2. **チャレンジ回数管理**: ユーザーが何回目のチャレンジかを記録
3. **分析用データ**: 失敗・成功セッションを区別して取得可能

## セッション定義
- **セッション開始**: ユーザーIDが設定されてゲームが開始された時点
- **セッション終了**: 以下のいずれかが発生した時点
  - ゲームクリア（成功）
  - 制約違反でゲームオーバー（失敗）
  - ユーザーがリセットボタンを押した（中断）

## データベース設計の拡張

### 新しいカラム
- `session_number`: ユーザーの何回目のチャレンジか（1から始まる連番）
- `session_status`: セッションの状態
  - 'active': 進行中
  - 'completed': ゲームクリア
  - 'failed': 制約違反
  - 'abandoned': ユーザーがリセット
- `session_start_time`: セッション開始時刻
- `session_end_time`: セッション終了時刻（NULLの場合は進行中）

### データ管理
- ユーザーごとにセッション番号を管理
- セッション開始時に新しいセッション番号を発行
- セッション終了時にステータスと終了時刻を更新

## 実装方針
1. Supabaseテーブルにカラム追加
2. セッション管理ロジックをReactアプリに実装
3. セッション開始・終了の処理を追加
4. 分析用のデータ取得関数を作成

---

# 分析ツールの設計

## 概要
管理者向けの統計分析ツール。ゲームの利用状況や成績を可視化し、ユーザーの行動パターンを分析できる独立したWebページ。

## 主要機能

### 1. アクセス制御
- **利用者**: 管理者のみ
- **認証方式**: パスワード認証（単一の管理者パスワード）
- **セキュリティ**: 管理者以外は他ユーザーのデータを絶対に閲覧不可

### 2. ユーザー個別統計
- **初回クリアまでの挑戦回数**: 失敗セッションも含めた総セッション数
- **最小クリア手数**: 全成功セッションの中での最小手数
- **成績推移グラフ**: 時系列での手数変化、成功率の推移

### 3. 全体統計
- **解けた人数**: ユニークユーザー数（完了ステータスを持つ）
- **平均挑戦回数**: 初回クリアまでの平均セッション数
- **制約違反分析**: 
  - ネコ・ウサギの制約違反回数
  - ウサギ・野菜の制約違反回数
  - 違反パターンの割合表示
- **期間フィルタ**: 今日/今週/今月/全期間での絞り込み
- **ランキング機能**:
  - 最速クリア（最小手数）TOP10
  - 最短時間クリアTOP10
  - 初回クリア達成者TOP10

### 4. データ可視化
- **グラフ/チャート**: 
  - 円グラフ（制約違反の割合）
  - 棒グラフ（ユーザー別成績）
  - 折れ線グラフ（時系列推移）
- **更新方式**: リアルタイム自動更新（WebSocketまたはポーリング）

### 5. エクスポート機能
- **対応形式**: CSV、PDF
- **エクスポート範囲**:
  - 全データ
  - 特定期間のデータ
  - 特定ユーザーのデータ
  - フィルタ適用後のデータ

## 技術仕様

### アーキテクチャ
- **フロントエンド**: React（既存アプリとは独立）
- **ルーティング**: React Router（/admin/analytics）
- **状態管理**: React Hooks
- **データ取得**: Supabase Realtime subscriptions
- **グラフライブラリ**: Chart.js または Recharts

### パフォーマンス要件
- **想定ユーザー数**: 最大100名
- **データ量**: 特別な最適化は不要
- **更新頻度**: 5秒ごとのポーリングまたはリアルタイム

### セキュリティ要件
- パスワードは環境変数で管理
- 管理者セッションのタイムアウト設定（30分）
- HTTPSでの通信必須

---

# ニックネーム機能設計

## 概要
ユーザーがユーザーIDとは別にニックネームを登録できる機能を追加し、分析ダッシュボードでニックネーム表示を優先する。

## 機能要件

### 1. ニックネーム登録
- ユーザーID入力時にニックネームも同時入力可能
- ニックネームは任意（未入力の場合はユーザーIDを表示）
- 既存ユーザーも後からニックネーム設定可能

### 2. データベース設計
- 新テーブル `user_profiles` を作成
  - user_id (primary key)
  - nickname (varchar)
  - created_at (timestamp)
  - updated_at (timestamp)

### 3. 分析ダッシュボード表示
- デフォルト：ニックネーム表示（未設定時はユーザーID）
- 切替ボタンでユーザーID⇔ニックネーム表示を切替
- ランキング、ユーザー選択リスト、詳細表示すべてに適用

## 技術実装

### データベース
```sql
CREATE TABLE user_profiles (
  user_id VARCHAR PRIMARY KEY,
  nickname VARCHAR,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### フロントエンド
1. App.js: ユーザーID入力時にニックネーム入力フィールド追加
2. supabaseClient.js: ニックネーム関連のCRUD操作関数追加
3. AnalyticsDashboard.js: 表示切替機能追加

### UX考慮点
- ニックネームは20文字以内
- 重複チェックは行わない（同じニックネームでも可）
- 既存ユーザーへの影響を最小化

---

# 船からアイテムを降ろす機能設計

## 概要
船に乗せたアイテムを再度クリックすることで降ろせる機能を追加し、その操作もログに記録する。

## 機能要件

### 1. インタラクション
- 船内のアイテムをクリック可能にする
- クリックすると元の岸に戻る
- 降ろす操作のフィードバック（アニメーション）

### 2. ログ記録
- 新しい操作タイプ「降ろす」を追加
- 操作対象：降ろしたアイテム名
- 船の位置（左岸/右岸）も記録

### 3. UI変更
- 船内アイテムにホバー効果追加
- カーソルをポインターに変更
- ツールチップで「クリックして降ろす」を表示

## 技術実装

### App.js修正点
1. 船内アイテムのクリックハンドラー追加
2. removeFromBoat関数の実装
3. ログエントリーに「降ろす」操作を追加

### 実装詳細
```javascript
// 船から降ろす関数
const removeFromBoat = async (item) => {
  const newBoat = gameState.boat.filter(i => i !== item);
  const targetSide = gameState.boatSide === 'left' ? 'leftSide' : 'rightSide';
  const newSideItems = [...gameState[targetSide], item];
  
  const newState = {
    ...gameState,
    boat: newBoat,
    [targetSide]: newSideItems
  };
  
  // ログ記録
  const logEntry = await createLogEntry(
    newState.moves + 1,
    '降ろす',
    items[item]?.name,
    newState.leftSide,
    newState.rightSide,
    newState.boat,
    newState.moves
  );
  
  setGameState(newState);
};
```