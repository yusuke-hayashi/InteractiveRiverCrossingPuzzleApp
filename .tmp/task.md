# セッション管理機能実装タスク

## タスク詳細

### 1. Supabaseテーブルにセッション管理カラムを追加
- [x] game_logsテーブルにカラム追加のマイグレーション実行
  - `session_number` (integer): ユーザーの何回目のチャレンジか
  - `session_status` (text): セッション状態 ('active', 'completed', 'failed', 'abandoned')
  - `session_start_time` (timestamptz): セッション開始時刻
  - `session_end_time` (timestamptz): セッション終了時刻（NULL可）
- [x] インデックス追加（user_id + session_numberの複合インデックス）

### 2. セッション番号管理機能を実装
- [x] ユーザーの最新セッション番号を取得する関数 (getLatestSessionNumber)
- [x] 新しいセッション番号を発行する機能 (startNewSession)
- [x] セッション開始時の初期化処理 (initializeNewSession)

### 3. セッション開始・終了処理を追加
- [x] ユーザーID入力時のセッション開始処理
- [x] ゲームクリア時のセッション完了処理
- [x] 制約違反時のセッション失敗処理
- [x] リセット時のセッション中断処理

### 4. セッション状態更新機能を実装
- [x] セッション状態を更新するSupabase関数 (updateSessionStatus)
- [x] セッション終了時刻の記録

### 5. 分析用データ取得関数を作成
- [x] ユーザーのセッション一覧取得関数 (getUserSessions)
- [x] 成功セッションのみ取得する関数 (getSuccessfulSessions)
- [x] 失敗セッションのみ取得する関数 (getFailedSessions)
- [x] セッション統計情報取得関数 (getSessionStatistics)

## 実装順序
1. Supabaseテーブル拡張
2. React側のセッション管理ロジック実装
3. セッション開始・終了処理の統合
4. 分析用関数の実装とテスト

---

# 分析ツール実装タスク

## タスク詳細

### 1. プロジェクト構造の準備
- [ ] React Routerのインストールと設定
- [ ] /admin/analytics ルートの追加
- [ ] 管理者用レイアウトコンポーネントの作成

### 2. 認証機能の実装
- [ ] 管理者パスワード認証画面の作成
- [ ] 環境変数での管理者パスワード設定（.env）
- [ ] セッション管理（30分タイムアウト）
- [ ] 認証状態の管理（Context API）

### 3. データ取得レイヤーの実装
- [ ] Supabase統計情報取得関数の作成
  - [ ] ユーザー別統計の取得
  - [ ] 全体統計の取得
  - [ ] 制約違反データの集計
  - [ ] ランキングデータの取得
- [ ] リアルタイム更新の設定（Supabase Realtime）
- [ ] 期間フィルタリング機能

### 4. UI コンポーネントの開発
- [ ] ダッシュボード画面の基本レイアウト
- [ ] 統計カードコンポーネント（数値表示）
- [ ] フィルターコンポーネント（期間選択）
- [ ] ユーザー検索・選択コンポーネント

### 5. グラフ・チャート機能
- [ ] Chart.jsまたはRechartsのインストール
- [ ] 円グラフ（制約違反の割合）
- [ ] 棒グラフ（ユーザー別成績）
- [ ] 折れ線グラフ（時系列推移）
- [ ] ランキング表示コンポーネント

### 6. 個別ユーザー分析画面
- [ ] ユーザー詳細画面の作成
- [ ] セッション履歴の表示
- [ ] 成績推移グラフ
- [ ] 最高記録の表示

### 7. エクスポート機能
- [ ] CSV生成機能の実装
  - [ ] 全データエクスポート
  - [ ] フィルタ適用データのエクスポート
  - [ ] ユーザー別エクスポート
- [ ] PDF生成機能の実装（jsPDFなど）
- [ ] ダウンロードボタンの配置

### 8. リアルタイム更新機能
- [ ] Supabase Realtimeサブスクリプション設定
- [ ] 新規データ受信時の画面更新
- [ ] 接続状態の表示
- [ ] エラーハンドリング

### 9. レスポンシブ対応
- [ ] モバイル画面対応
- [ ] タブレット画面対応
- [ ] グラフのレスポンシブ対応

### 10. テストとデバッグ
- [ ] 統計計算の正確性確認
- [ ] 認証フローのテスト
- [ ] エクスポート機能のテスト
- [ ] パフォーマンステスト（100人分のデータ）

## 実装順序
1. プロジェクト構造とルーティング設定
2. 認証機能の実装
3. 基本的なダッシュボード画面
4. データ取得レイヤー
5. グラフ・チャート機能
6. エクスポート機能
7. リアルタイム更新
8. レスポンシブ対応とテスト

## 必要なパッケージ
- react-router-dom
- chart.js + react-chartjs-2（またはrecharts）
- jspdf + html2canvas（PDF生成用）
- date-fns（日付処理用）

---

# ニックネーム機能実装タスク

## 1. データベーススキーマ追加
- [ ] user_profilesテーブルを作成
- [ ] 必要なカラム（user_id, nickname, created_at, updated_at）を定義

## 2. ユーザー登録画面の改修
- [ ] App.jsのユーザーID入力モーダルにニックネーム欄を追加
- [ ] ニックネーム入力フィールドの UI実装
- [ ] バリデーション追加（20文字以内）

## 3. Supabase関数の実装
- [ ] ニックネーム保存関数 (saveUserProfile)
- [ ] ニックネーム取得関数 (getUserProfile)
- [ ] ニックネーム更新関数 (updateUserProfile)
- [ ] 全ユーザーのプロフィール取得関数 (getAllUserProfiles)

## 4. 分析ダッシュボードの改修
- [ ] ユーザー名表示切替機能（ニックネーム⇔ユーザーID）
- [ ] ランキング表示での切替対応
- [ ] ユーザー選択リストでの切替対応
- [ ] ユーザー詳細表示での切替対応

## 5. 既存ユーザー対応
- [ ] ニックネーム未設定ユーザーのフォールバック処理
- [ ] 既存ユーザーのニックネーム設定機能（オプション）

## 6. 動作確認とコミット
- [ ] 新規ユーザー登録での動作確認
- [ ] ダッシュボード表示切替の動作確認
- [ ] 既存ユーザーへの影響確認
- [ ] 変更をコミット